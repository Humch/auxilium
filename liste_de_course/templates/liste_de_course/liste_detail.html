{% extends "base.html" %}

{% block title %}{{ liste.nom }}{% endblock %}

{% block content %}
	<div class="column row">
		<h4>
			<span data-tooltip aria-haspopup="true" class="has-tip" data-disable-hover="false" tabindex="1" title="{{ liste.magasin.nom }}">
				<img src='{{ MEDIA_URL }}{{ liste.magasin.logo.name }}' width="32" height="32">
			</span>
			{{ liste.nom }} | 
			<a href='/a/l_maj/{{ liste.id }}'><i class="fi-refresh"></i></a>
			{% if user.is_superuser %}
				 | <a href='/a/l_delete/{{ liste.id }}'><i class="fi-x red-color"></i></a>
			{% endif %}
			{% if liste.archive %}
				| <form method="post" action="" class="archive_list inline_display">
					{% csrf_token %}
					<input type='hidden' name='liste_id' value='{{ liste.id }}' />
					<button type="submit"><i id="liste_{{ liste.id }}" class="fi-shopping-cart green-color"></i></button>
				</form>
			{% else %}
				| <form method="post" action="" class="archive_list inline_display">
					{% csrf_token %}
					<input type='hidden' name='liste_id' value='{{ liste.id }}' />
					<button type="submit"><i id="liste_{{ liste.id }}" class="fi-shopping-cart green-empty"></i></button>
				</form>
			{% endif %}
		</h4>
	</div>
	{% if liste.produit.all %}
		<div id="table_produit" class="column row">
			<table class="hover stack">
				<thead>
					<tr>
						<th>Produit</th>
						<th>Quantité</th>
					</tr>
				 </thead>
				<tbody>
					{% for produit in liste.produit.all %}
						<tr id="produit_{{produit.id}}">
							<td>{{ produit.nom }}</td>
							<td>
								<div class="small button-group">
									{% if liste.active %}
										<button type="button" class="pil-left button" onClick="modifyQuantity('soustract',{{ produit.id }})"><i class="fi-minus"></i></button>
										<button type="button" class="button" id="quantite_{{produit.id}}">{{ produit.quantite }}</button>
										<button type="button" class="pil-right button" onClick="modifyQuantity('add',{{ produit.id }})"><i class="fi-plus"></i></button>
									{% else %}
										<button type="button" class="disabled pil-left button"><i class="fi-minus"></i></button>
										<button type="button" class="button" id="quantite_{{produit.id}}">{{ produit.quantite }}</button>
										<button type="button" class="disabled pil-right button"><i class="fi-plus"></i></button>
									{% endif %}
								</div>
							</td>
						</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	{% endif %}
	{% if liste.active %}
		<div class="column row">
						<p class="text-center"><a class="button" data-open="ModalAddArticle">Ajouter un article <i class="fi-plus"></i></a></p>
				<div class="reveal" id="ModalAddArticle" data-reveal>
					<div class="success callout display_for_success" data-closable id="response">
						<p>l'article <span id="retour_article"></span> a été ajouté à la liste</p>
					</div>
					<div class="alert callout display_for_success" data-closable id="error_create">
						<p class="text-center"><i class="fi-alert red-color"></i> Erreur - l'article n'a pas été ajouté<i class="fi-alert red-color"></i></p>
					</div>
					<div class="column row margin-top">
						<form action="" method="post" id="ajout_article_liste">
							{% csrf_token %}
							<input type='hidden' name='liste_id' value='{{ liste.id }}' />
							<input type='hidden' id='article_id' name='article_id' value='' />
							{{ addarticle2list.as_p }}
							<p class="text-center"><input type="submit" class="button" value="Ajouter un article"></p>
						</form>
					</div>
					<button class="close-button" data-close aria-label="Close modal" type="button">
						<span aria-hidden="true">&times;</span>
					</button>
		</div>
	{% endif %}
{% endblock %}

{% block javascript %}
	<script type="text/javascript">
    $(function() {
        $('.archive_list').submit(function() {
            $.ajax({ 
                data: $(this).serialize(),
                type:'POST',
                url: '/a/archive_list/',
				dataType : "json",
				cache: false,
				success:  function(data) {
					if (data.state == "archive") {
						$("#liste_" + data.listeid).removeClass("green-empty").addClass("green-color");
                    }
					else if (data.state == "active") {
                        $("#liste_" + data.listeid).removeClass("green-color").addClass("green-empty");
                    }
				}
			});
            return false;
        });
    });
	</script>
	
	<script type="text/javascript">
		$(function() {
			$('#ajout_article_liste').submit(function() {
				$.ajax({ 
					data: $(this).serialize(),
					type:'POST',
					url: '/a/add_to_list/',
					dataType : "jsonp",
					cache: false,
					success:  $(function() {
						$("#response").show();
						setTimeout(function() {
							$("#response").hide();
							$("#ModalAddArticle").foundation('close');
						}, 2000 );
						location.reload();
					})
				});
				return false;
			});
		});
	</script>
	
	<script type="text/javascript">
        $(function() {
            $("#article").autocomplete({
                source: "/a/get_article/",
                minLength: 4,
				select:function(e,u){ 
                $("#article").text(u.item.label);
                $("#article_id").val(u.item.id);
				}
            });
        });
	</script>
	
	<script type="text/javascript">
	// récupérer le cookie CSRF Token pour les requêtes AJAX
	function getCookie(name) {
		var cookieValue = null;
		if (document.cookie && document.cookie !== '') {
			var cookies = document.cookie.split(';');
			for (var i = 0; i < cookies.length; i++) {
				var cookie = jQuery.trim(cookies[i]);
				// Does this cookie string begin with the name we want?
				if (cookie.substring(0, name.length + 1) === (name + '=')) {
					cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
					break;
				}
			}
		}
		return cookieValue;
	}
	
	var csrftoken = getCookie('csrftoken');
	</script>
	
	<script type="text/javascript">
		function modifyQuantity(action,produit_id,csrftoken){
				$.ajax({
					url:'/a/modify_product_quantity/',
					data: {action: action, produit_id : produit_id, csrfmiddlewaretoken : window.csrftoken},
					dataType: "json",
					type: 'POST',
					success: function(result) {
						if (result.state == "updated") {
							$("#quantite_" + result.produit_id).html(result.quantite);
						}
						else if (result.state == "deleted") {
							$("#produit_" + result.produit_id).remove();
						}
					}
				});
		}
	</script>

{% endblock %}